FROM node:18-alpine

# Install Java (required for OpenAPI Generator)
RUN apk add --no-cache openjdk17-jre

# Install OpenAPI Generator CLI globally as root
RUN npm install -g @openapitools/openapi-generator-cli

# Accept build args for user ID and group ID
ARG USER_ID=1000
ARG GROUP_ID=1000

# Create node user with host UID/GID 
RUN (deluser node 2>/dev/null || true) && \
    TARGET_GROUP=$(getent group $GROUP_ID | cut -d: -f1 2>/dev/null || echo "") && \
    if [ -z "$TARGET_GROUP" ]; then \
        addgroup -g $GROUP_ID hostgroup && \
        TARGET_GROUP=hostgroup; \
    fi && \
    adduser -D -u $USER_ID -G $TARGET_GROUP node

# Create app directory and set permissions  
WORKDIR /app
RUN chown -R $USER_ID:$GROUP_ID /app

# Switch to node user
USER node

# Copy package files and install dependencies
COPY --chown=$USER_ID:$GROUP_ID package*.json ./
RUN npm install

# Create client directory structure
RUN mkdir -p src/client/docs

# Expose port
EXPOSE 3000

# Start development server
CMD ["sleep", "500"]
