FROM node:18-alpine

# Install Java (required for OpenAPI Generator)
RUN apk add --no-cache openjdk17-jre

# Install OpenAPI Generator CLI globally as root
RUN npm install -g @openapitools/openapi-generator-cli

# Accept build args for user ID and group ID
ARG USER_ID=1000
ARG GROUP_ID=1000

# Modify existing node user to match host user ID
RUN deluser node && \
    addgroup -g $GROUP_ID node && \
    adduser -D -u $USER_ID -G node node

# Create app directory and set permissions
WORKDIR /app
RUN chown -R node:node /app

# Switch to node user
USER node

# Copy package files and install dependencies
COPY --chown=node:node package*.json ./
RUN npm install

# Create client directory structure
RUN mkdir -p src/client/docs

# Expose port
EXPOSE 3000

# Start development server
CMD ["npm", "run", "dev"]