FROM node:18-alpine

# Install Java (required for OpenAPI Generator)
RUN apk add --no-cache openjdk17-jre

# Install OpenAPI Generator CLI globally as root
RUN npm install -g @openapitools/openapi-generator-cli

# Accept build args for user ID and group ID
ARG USER_ID=1000
ARG GROUP_ID=1000

# Create a user with the same ID as the host user, handling existing IDs
RUN (addgroup -g $GROUP_ID appgroup || addgroup appgroup) && \
    (adduser -D -u $USER_ID -G appgroup appuser || adduser -D -G appgroup appuser)

# Create app directory and set permissions
WORKDIR /app
RUN chown -R appuser:appgroup /app

# Switch to app user
USER appuser

# Copy package files and install dependencies
COPY --chown=appuser:appgroup package*.json ./
RUN npm install

# Create client directory structure for OpenAPI generator
RUN mkdir -p src/client/docs

# Expose port
EXPOSE 3000

# Start development server
CMD ["npm", "run", "dev"]